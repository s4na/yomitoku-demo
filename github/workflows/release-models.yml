name: Release ONNX Models

on:
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
  # push:
  #   tags:
  #     - 'models-v*'  # models-v1, models-v2 ãªã©ã®ã‚¿ã‚°ã§ãƒˆãƒªã‚¬ãƒ¼

permissions:
  contents: write

jobs:
  export-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Install YomiToku
        run: |
          pip install yomitoku torch --no-cache-dir
          pip list | grep yomitoku

      - name: ğŸ“¥ Export ONNX models
        run: |
          mkdir -p models
          python3 << 'EOF'
          from yomitoku import DocumentAnalyzer
          import os

          print("ğŸ”„ Initializing YomiToku DocumentAnalyzer...")
          analyzer = DocumentAnalyzer(configs={"device": "cpu"})

          # Export detector model
          print("ğŸ“¥ Exporting detector model to ONNX...")
          detector = analyzer.detector
          detector.infer_onnx = True
          detector.export_model_to_onnx("./models/text_detector.onnx")

          # Verify detector model
          detector_size = os.path.getsize("./models/text_detector.onnx")
          print(f"âœ… Detector model exported: {detector_size / 1024 / 1024:.2f} MB")

          # Export recognizer model
          print("ğŸ“¥ Exporting recognizer model to ONNX...")
          recognizer = analyzer.recognizer
          recognizer.infer_onnx = True
          recognizer.export_model_to_onnx("./models/text_recognizer.onnx")

          # Verify recognizer model
          recognizer_size = os.path.getsize("./models/text_recognizer.onnx")
          print(f"âœ… Recognizer model exported: {recognizer_size / 1024 / 1024:.2f} MB")

          # Total size
          total_size = (detector_size + recognizer_size) / 1024 / 1024
          print(f"ğŸ“Š Total size: {total_size:.2f} MB")
          EOF

      - name: ğŸ“‹ Verify model files
        run: |
          echo "Checking exported model files..."
          ls -lh models/*.onnx

          # Verify file sizes (should be at least 1MB each)
          for file in models/*.onnx; do
            size=$(stat -c%s "$file")
            if [ "$size" -lt 1000000 ]; then
              echo "âŒ Error: $file is too small (${size} bytes)"
              exit 1
            fi
            echo "âœ… $file: $(($size / 1024 / 1024)) MB"
          done

      - name: ğŸ·ï¸ Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: models-v1
          name: YomiToku ONNX Models v1
          body: |
            # YomiToku ONNX Models

            ã“ã®ãƒªãƒªãƒ¼ã‚¹ã«ã¯ã€YomiToku Liteã§ä½¿ç”¨ã™ã‚‹ONNXãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

            ## ğŸ“¦ å«ã¾ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«

            - **text_detector.onnx** - ãƒ†ã‚­ã‚¹ãƒˆæ¤œå‡ºãƒ¢ãƒ‡ãƒ«ï¼ˆDBNet v2ï¼‰
            - **text_recognizer.onnx** - ãƒ†ã‚­ã‚¹ãƒˆèªè­˜ãƒ¢ãƒ‡ãƒ«ï¼ˆPARSeqï¼‰

            ## ğŸš€ ä½¿ç”¨æ–¹æ³•

            ### GitHub Pagesã§è‡ªå‹•çš„ã«èª­ã¿è¾¼ã‚€

            ã“ã®ãƒªãƒªãƒ¼ã‚¹ã®ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€GitHub Pagesãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«è‡ªå‹•çš„ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™ã€‚
            ãƒ‡ãƒ¢ã‚µã‚¤ãƒˆ: https://s4na.github.io/yomitoku-demo/

            ### æ‰‹å‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

            ```bash
            # ãƒªãƒã‚¸ãƒˆãƒªã®modelsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§å®Ÿè¡Œ
            wget https://github.com/s4na/yomitoku-demo/releases/download/models-v1/text_detector.onnx
            wget https://github.com/s4na/yomitoku-demo/releases/download/models-v1/text_recognizer.onnx
            ```

            ## ğŸ“„ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

            ã“ã‚Œã‚‰ã®ãƒ¢ãƒ‡ãƒ«ã¯ **CC BY-NC-SA 4.0** ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã§æä¾›ã•ã‚Œã¦ã„ã¾ã™ï¼š
            - âœ… å€‹äººåˆ©ç”¨ãƒ»ç ”ç©¶ç›®çš„ã¯ç„¡æ–™
            - âœ… éå•†ç”¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ç„¡æ–™
            - âŒ å•†ç”¨åˆ©ç”¨ã«ã¯åˆ¥é€”ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãŒå¿…è¦

            è©³ç´°: https://www.mlism.com/

            ## ğŸ™ è¬è¾

            ã“ã‚Œã‚‰ã®ãƒ¢ãƒ‡ãƒ«ã¯ [YomiToku](https://github.com/kotaro-kinoshita/yomitoku) ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰æä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚
          draft: false
          prerelease: false
          files: |
            models/text_detector.onnx
            models/text_recognizer.onnx
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Release Complete
        run: |
          echo "ğŸ‰ Models successfully released!"
          echo "ğŸ“¥ Download URLs:"
          echo "  - https://github.com/${{ github.repository }}/releases/download/models-v1/text_detector.onnx"
          echo "  - https://github.com/${{ github.repository }}/releases/download/models-v1/text_recognizer.onnx"
